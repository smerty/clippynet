<!DOCTYPE html>
<!--
The Unlicense (Public Domain)

This is free and unencumbered software released into the public domain.

Anyone is free to copy, modify, publish, use, compile, sell, or distribute this software, either in source code form 
or as a compiled binary, for any purpose, commercial or non-commercial, and by any means.

In jurisdictions that recognize copyright laws, the author or authors of this software dedicate any and all copyright 
interest in the software to the public domain. We make this dedication for the benefit of the public at large and to 
the detriment of our heirs and successors. We intend this dedication to be an overt act of relinquishment in perpetuity 
of all present and future rights to this software under copyright law.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS BE 
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, 
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

For more information, please refer to <https://unlicense.org>
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClippyNet // Terminal File Transfer</title>
    <style>
        :root {
            /* Palette: Slate */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-terminal: #0f172a;
            --bg-terminal-header: #1e293b;
            
            --border-subtle: #e2e8f0;
            --border-active: #94a3b8;
            
            --text-main: #334155;
            --text-muted: #64748b;
            --text-terminal: #e2e8f0;
            
            /* Accents */
            --primary: #4f46e5;       /* Indigo 600 */
            --primary-hover: #4338ca; /* Indigo 700 */
            --success: #10b981;       /* Emerald 500 */
            
            --radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #020617;
                --bg-card: #0f172a;
                --bg-terminal: #020617; 
                --bg-terminal-header: #1e293b;
                
                --border-subtle: #1e293b;
                --border-active: #475569;
                
                --text-main: #f8fafc;
                --text-muted: #94a3b8;
                --text-terminal: #f8fafc;
                
                --primary: #6366f1;       /* Indigo 500 */
                --primary-hover: #818cf8; /* Indigo 400 */
            }
        }
        
        * { box-sizing: border-box; }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 0 4px;
        }

        .brand {
            font-weight: 600;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-main);
            text-decoration: none;
        }

        .brand svg { color: var(--primary); }

        .gh-link {
            color: var(--text-muted);
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .gh-link:hover { color: var(--primary); }

        /* --- Main Application Shell --- */
        main {
            width: 100%;
            max-width: 800px;
            display: grid;
            gap: 24px;
        }

        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: border-color 0.2s;
        }

        /* --- Input Zone --- */
        .upload-area {
            position: relative;
            padding: 40px;
            text-align: center;
            /* No border-bottom since action bar is integrated/optional now */
            transition: background 0.2s;
        }

        .drop-zone {
            border: 2px dashed var(--border-subtle);
            border-radius: var(--radius);
            padding: 32px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--primary);
            background-color: rgba(79, 70, 229, 0.05);
        }

        .drop-icon {
            color: var(--text-muted);
            background: var(--bg-body);
            padding: 12px;
            border-radius: 50%;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            inset: 0;
            cursor: pointer;
        }

        /* --- File Meta Bar (Appears after selection) --- */
        #fileMetaBar {
            display: none; /* Hidden until file selected */
            padding: 16px 24px;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-card);
            align-items: center;
            justify-content: space-between;
        }

        .file-info-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon-small {
            color: var(--primary);
        }

        .filename {
            font-weight: 600;
            color: var(--text-main);
            font-size: 14px;
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .filesize {
            color: var(--text-muted);
            font-family: 'Courier New', Consolas, Monaco, monospace;
            font-size: 12px;
        }

        .status-badge {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Spinning loader for "Generating..." */
        .loader {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border-subtle);
            border-bottom-color: var(--primary);
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            display: none;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Results Terminal Style --- */
        #resultContainer { display: none; }

        .terminal-group {
            margin-bottom: 24px;
        }

        .terminal-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-window {
            background: var(--bg-terminal);
            border-radius: var(--radius);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            background: var(--bg-terminal-header);
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
            min-height: 42px;
        }

        .terminal-title {
            color: #94a3b8;
            font-size: 12px;
            font-family: system-ui, -apple-system, sans-serif;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .terminal-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid transparent;
            color: #94a3b8;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-btn:hover {
            color: #f1f5f9;
            background: rgba(255,255,255,0.05);
        }

        .action-btn.copy-btn {
            border-color: #475569;
            color: #e2e8f0;
        }
        
        .action-btn.copy-btn:hover {
            border-color: #94a3b8;
            background: rgba(255,255,255,0.1);
        }

        .action-btn.copied {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        /* --- Collapsible Code Blocks --- */
        .code-wrapper {
            position: relative;
            background: var(--bg-terminal);
        }

        .code-block {
            padding: 16px;
            margin: 0;
            color: var(--text-terminal);
            font-family: 'Courier New', Consolas, Monaco, monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.6;
            overflow-x: hidden;
            /* Default expanded state logic handled via classes below */
        }
        
        /* Collapsed State */
        .code-wrapper.collapsed .code-block {
            max-height: 140px;
            overflow-y: hidden;
        }

        /* Gradient Overlay for Collapsed State */
        .code-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(to bottom, transparent, var(--bg-terminal));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .code-wrapper.collapsed .code-overlay {
            opacity: 1;
        }

        /* Scrollbar styling */
        .code-block::-webkit-scrollbar { width: 8px; height: 8px; }
        .code-block::-webkit-scrollbar-track { background: var(--bg-terminal); }
        .code-block::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .stat-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: #94a3b8;
            margin-left: 8px;
        }

        .stat-badge.green { color: #34d399; background: rgba(52, 211, 153, 0.1); }

        /* --- Footer / Info --- */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card h3 {
            font-size: 14px;
            margin: 0 0 8px 0;
            color: var(--text-main);
        }

        .info-card ul {
            margin: 0;
            padding-left: 16px;
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .info-card li { margin-bottom: 6px; }

        .alerts { margin: 16px 0 0 0; }
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            display: none;
        }
        .alert-error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-warning { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }

    </style>
</head>
<body>

    <header>
        <a href="#" class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
            ClippyNet
        </a>
        <a href="https://github.com/smerty/clippynet" target="_blank" class="gh-link">
            <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
            View Source
        </a>
    </header>

    <main>
        <!-- Input Panel -->
        <div class="panel">
            <div class="upload-area">
                <div id="dropZone" class="drop-zone" role="button" tabindex="0">
                    <div class="drop-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <div>
                        <span style="font-weight: 500; color: var(--text-main);">Drag & drop file</span>
                        <span style="color: var(--text-muted);"> or click to browse</span>
                    </div>
                    <input type="file" id="fileInput" class="file-input" aria-label="Select file">
                </div>
            </div>
            
            <div id="fileMetaBar">
                <div class="file-info-group">
                    <svg class="file-icon-small" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                    <div>
                        <div id="selectedFileName" class="filename"></div>
                        <div id="selectedFileSize" class="filesize"></div>
                    </div>
                </div>
                <div class="status-badge">
                    <span class="loader" id="loader"></span>
                    <span id="statusText">Ready</span>
                </div>
            </div>
            
            <div class="alerts">
                <div id="errorMessage" class="alert alert-error" role="alert"></div>
                <div id="warningMessage" class="alert alert-warning" role="status"></div>
            </div>
        </div>

        <!-- Result Panel -->
        <div id="resultContainer">
            
            <!-- Linux Group -->
            <div class="terminal-group">
                <div class="terminal-label">
                    <span>Linux / macOS</span>
                    <span style="font-size: 11px; opacity: 0.7;">BASH / ZSH</span>
                </div>
                
                <!-- Compressed -->
                <div class="terminal-window" style="margin-bottom: 16px;">
                    <div class="terminal-header">
                        <div class="terminal-title">
                            Compressed (gzip)
                            <span id="compSizeBadge" class="stat-badge"></span>
                        </div>
                        <div class="terminal-actions">
                            <button id="compressedExpandBtn" class="action-btn" onclick="toggleExpand('linuxCompressedWrapper', this)">Expand</button>
                            <button class="action-btn copy-btn" onclick="copyCommand('linuxCompressedCommand', this)">Copy</button>
                        </div>
                    </div>
                    <div id="linuxCompressedWrapper" class="code-wrapper collapsed">
                        <div class="code-block" id="linuxCompressedCommand"></div>
                        <div class="code-overlay"></div>
                    </div>
                </div>

                <!-- Standard -->
                <div class="terminal-window">
                    <div class="terminal-header">
                        <div class="terminal-title">Standard (No Compression)</div>
                        <div class="terminal-actions">
                            <button class="action-btn" onclick="toggleExpand('linuxStandardWrapper', this)">Expand</button>
                            <button class="action-btn copy-btn" onclick="copyCommand('linuxStandardCommand', this)">Copy</button>
                        </div>
                    </div>
                    <div id="linuxStandardWrapper" class="code-wrapper collapsed">
                        <div class="code-block" id="linuxStandardCommand"></div>
                        <div class="code-overlay"></div>
                    </div>
                </div>
            </div>

            <!-- Windows Group -->
            <div class="terminal-group">
                <div class="terminal-label">
                    <span>Windows</span>
                    <span style="font-size: 11px; opacity: 0.7;">PowerShell 5.1+ / Core 6+</span>
                </div>
                <div class="terminal-window">
                    <div class="terminal-header">
                        <div class="terminal-title">PowerShell Restore</div>
                        <div class="terminal-actions">
                            <button class="action-btn" onclick="toggleExpand('powershellWrapper', this)">Expand</button>
                            <button class="action-btn copy-btn" onclick="copyCommand('powershellCommand', this)">Copy</button>
                        </div>
                    </div>
                    <div id="powershellWrapper" class="code-wrapper collapsed">
                        <div class="code-block" id="powershellCommand"></div>
                        <div class="code-overlay"></div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Info Grid -->
        <div class="info-grid">
            <div class="info-card">
                <h3>Privacy & Security</h3>
                <ul>
                    <li>Files never leave your browser (Client-side API).</li>
                    <li>Filenames are sanitized to prevent shell injection.</li>
                    <li>Offline capable (No external dependencies).</li>
                </ul>
            </div>
            <div class="info-card">
                <h3>Usage Tips</h3>
                <ul>
                    <li>Best for small config files or binaries (< 10MB).</li>
                    <li>Base64 increases size by ~33%.</li>
                    <li>Use "Compressed" for text/logs to save space.</li>
                </ul>
            </div>
        </div>
    </main>

    <script>
        // Constants
        const MAX_RECOMMENDED_SIZE = 10 * 1024 * 1024; // 10MB
        
        // Setup Drag and Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('selectedFileName');
        const fileSizeDisplay = document.getElementById('selectedFileSize');
        const fileMetaBar = document.getElementById('fileMetaBar');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('statusText');

        // Keyboard accessibility for drop zone
        dropZone.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                fileInput.click();
            }
        });

        // Drag Visuals
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const droppedFiles = e.dataTransfer.files;
            if (droppedFiles.length === 1) {
                fileInput.files = droppedFiles;
                handleFileSelection();
            } else if (droppedFiles.length > 1) {
                const warningMessageEl = document.getElementById('warningMessage');
                if (warningMessageEl) {
                    warningMessageEl.textContent = 'Please drop only one file. Processing of multiple files is not supported.';
                    warningMessageEl.style.display = 'flex';
                }
            }
        });

        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection() {
            const files = fileInput.files;
            const warningMessageEl = document.getElementById('warningMessage');

            if (files.length > 1) {
                if (warningMessageEl) {
                    warningMessageEl.textContent = 'Please select only one file. Processing of multiple files is not supported.';
                    warningMessageEl.style.display = 'flex';
                }
                // Clear the selection so the user can try again with a single file
                fileInput.value = '';
                return;
            }

            const file = files[0];
            if (file) {
                // Update Meta UI
                fileMetaBar.style.display = 'flex';
                fileNameDisplay.textContent = file.name;
                fileSizeDisplay.textContent = formatSize(file.size);
                
                // Clear and Hide previous results
                document.getElementById('resultContainer').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('warningMessage').style.display = 'none';
                
                // Reset collapse states - expand compressed command by default as it's most useful
                document.querySelectorAll('.code-wrapper').forEach(el => el.classList.add('collapsed'));
                // Expand the compressed command by default
                const compressedWrapper = document.getElementById('linuxCompressedWrapper');
                if (compressedWrapper) {
                    compressedWrapper.classList.remove('collapsed');
                }
                document.querySelectorAll('.action-btn').forEach(btn => { 
                    if(btn.textContent === 'Collapse') btn.textContent = 'Expand'; 
                });
                // Update the compressed command expand button
                const compressedExpandBtn = document.getElementById('compressedExpandBtn');
                if (compressedExpandBtn) {
                    compressedExpandBtn.textContent = 'Collapse';
                }

                // Trigger Processing automatically
                processFile(file);
            }
        }

        async function processFile(file) {
            // UI Status: Processing
            loader.style.display = 'block';
            statusText.textContent = 'Generating...';
            
            try {
                // Size Warning
                if (file.size > MAX_RECOMMENDED_SIZE) {
                    showWarning(`Large file (${formatSize(file.size)}). Browser freeze possible.`);
                }

                // Sanitize filename
                const originalName = file.name;
                const safeName = sanitizeFilename(originalName);
                if (safeName !== originalName) {
                    showWarning(`Filename sanitized from "${originalName}" to "${safeName}". Output file will be named "${safeName}".`);
                }

                // 1. Standard Base64
                // Yield to next animation frame to allow UI to render "Generating..." before heavy work freezes thread
                await new Promise(resolve => requestAnimationFrame(() => resolve()));
                const standardBase64 = await readFileAsBase64(file);
                
                // 2. Compressed Base64
                let compressedBase64 = null;
                if ('CompressionStream' in window) {
                    try {
                        const compressedBlob = await compressFile(file);
                        compressedBase64 = await readFileAsBase64(compressedBlob);
                    } catch (e) {
                        console.warn('Compression skipped', e);
                        showWarning('Compression failed. Falling back to the standard (uncompressed) command.');
                    }
                } else {
                    showWarning('Compression not supported in this browser. Using standard command only.');
                }

                // Generate Commands
                const standardLinuxCommand = `printf '${standardBase64}' | base64 -d > "${safeName}"`;
                const powershellCommand = `[System.IO.File]::WriteAllBytes("${safeName}", [System.Convert]::FromBase64String('${standardBase64}'))`;
                
                // Render Standard
                document.getElementById('linuxStandardCommand').textContent = standardLinuxCommand;
                document.getElementById('powershellCommand').textContent = powershellCommand;
                
                // Render Compressed
                const compCmdContainer = document.getElementById('linuxCompressedCommand');
                const compBadge = document.getElementById('compSizeBadge');
                
                if (compressedBase64) {
                    const compressedLinuxCommand = `printf '${compressedBase64}' | base64 -d | gzip -d > "${safeName}"`;
                    compCmdContainer.textContent = compressedLinuxCommand;
                    
                    const standardLen = standardLinuxCommand.length;
                    const compressedLen = compressedLinuxCommand.length;
                    const percentDiff = ((standardLen - compressedLen) / standardLen * 100).toFixed(0);
                    
                    if (percentDiff > 0) {
                        compBadge.textContent = `${percentDiff}% Smaller`;
                        compBadge.classList.add('green');
                    } else {
                        // Show that compression made it larger
                        const increase = Math.abs(percentDiff);
                        compBadge.textContent = `${increase}% Larger`;
                        compBadge.classList.remove('green');
                    }
                } else {
                    compCmdContainer.textContent = "# Compression not supported in this browser";
                }
                
                // Reveal
                document.getElementById('resultContainer').style.display = 'block';
                statusText.textContent = 'Complete';

            } catch (error) {
                console.error(error);
                showError(error.message);
                statusText.textContent = 'Error';
            } finally {
                loader.style.display = 'none';
            }
        }
        
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            const chunkSize = 0x8000; // 32KB chunks to avoid argument limits
            let binary = '';

            for (let i = 0; i < bytes.length; i += chunkSize) {
                const chunk = bytes.subarray(i, i + chunkSize);
                binary += String.fromCharCode.apply(null, chunk);
            }

            return btoa(binary);
        }

        function readFileAsBase64(blob) {
            // Guard against very large files that may exhaust memory in the browser
            const MAX_SAFE_SIZE_BYTES = 50 * 1024 * 1024; // 50 MB
            if (blob.size > MAX_SAFE_SIZE_BYTES) {
                return Promise.reject(new Error('File is too large to process in the browser. Please use a file smaller than 50 MB.'));
            }

            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = () => {
                    try {
                        const base64 = arrayBufferToBase64(reader.result);
                        resolve(base64);
                    } catch (e) {
                        reject(e instanceof Error ? e : new Error('Failed to convert file to base64.'));
                    }
                };

                reader.onerror = () => {
                    reject(reader.error || new Error('Failed to read file.'));
                };

                reader.readAsArrayBuffer(blob);
            });
        }

        async function compressFile(file) {
            const stream = file.stream();
            const compressedStream = stream.pipeThrough(new CompressionStream('gzip'));
            return await new Response(compressedStream).blob();
        }

        function sanitizeFilename(name) {
            // Replace control characters and shell-dangerous punctuation with underscores,
            // while preserving spaces, parentheses, hyphens, dots, underscores, and Unicode characters.
            // Pattern explanation:
            // - \x00-\x1F: Control characters (0-31)
            // - \x7F: DEL character
            // - `: Backticks (command substitution)
            // - ": Double quotes (shell variable expansion)
            // - ': Single quotes (can break shell syntax)
            // - $: Dollar sign (shell variable expansion)
            // - \\: Backslash (escape character)
            // - <>|&;*?#!: Shell metacharacters (redirection, pipes, background, wildcards, etc.)
            return name.replace(/[\x00-\x1F\x7F`"'$\\<>|&;*?#!]/g, '_');
        }
        
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function copyCommand(elementId, buttonElement) {
            const commandText = document.getElementById(elementId).textContent;
            
            navigator.clipboard.writeText(commandText).then(() => {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'Copied';
                buttonElement.classList.add('copied');
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            }).catch(() => {
                alert('Copy failed. Select text manually.');
            });
        }

        function toggleExpand(wrapperId, btnElement) {
            const wrapper = document.getElementById(wrapperId);
            wrapper.classList.toggle('collapsed');
            
            if (wrapper.classList.contains('collapsed')) {
                btnElement.textContent = 'Expand';
            } else {
                btnElement.textContent = 'Collapse';
            }
        }
        
        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'flex';
        }

        function showWarning(message) {
            const el = document.getElementById('warningMessage');
            el.textContent = message;
            el.style.display = 'flex';
        }
    </script>
</body>
</html>
